<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Image Generator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            display: flex;
            min-height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: 300px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.3s ease;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .sidebar-content {
            min-height: min-content;
        }
        .sidebar h2 {
            margin: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            color: #ecf0f1;
        }
        .config-group {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 0;
        }
        .config-group h3 {
            margin: 0 0 15px 0;
            color: #3498db;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .config-group h3::before {
            content: "⚙️";
            font-size: 1.2em;
        }
        .input-group {
            margin-bottom: 15px;
            max-width: 200px;
        }
        .input-group:last-child {
            margin-bottom: 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #ecf0f1;
            font-size: 0.9em;
        }
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #3498db;
            background-color: rgba(255, 255, 255, 0.15);
        }
        .input-group textarea {
            min-height: 80px;
            resize: vertical;
            max-width: 100%;
        }
        .dimension-inputs {
            display: flex;
            gap: 10px;
            max-width: 200px;
            align-items: flex-end;
        }
        .dimension-inputs .input-group {
            flex: 1;
            margin-bottom: 0;
        }
        .switch-dimensions {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .switch-dimensions:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .switch-dimensions svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        #generateBtn {
            max-width: 200px;
            padding: 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0;
        }
        #generateBtn:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }
        #generateBtn:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            transform: none;
        }
        #status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            font-size: 0.9em;
        }
        .error-message {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        .cors-warning {
            background-color: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 0;
            border: 1px solid rgba(241, 196, 15, 0.3);
        }
        .cors-warning strong {
            color: #f1c40f;
        }
        .cors-warning a {
            color: #3498db;
            text-decoration: none;
        }
        .cors-warning a:hover {
            text-decoration: underline;
        }
        .cors-warning ol {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }
        .cors-warning li {
            margin-bottom: 5px;
        }
        .main-content {
            flex: 1;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f5f5f5;
            position: relative;
            overflow: hidden;
        }
        .container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
            background-color: white;
        }
        textarea {
            resize: vertical;
        }
        select {
            cursor: pointer;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        #result {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #000;
        }
        #generatedImage {
            max-width: 100%;
            max-height: 100vh;
            width: auto;
            height: auto;
            object-fit: contain;
            display: none;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        .navigation-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 4px;
            z-index: 10;
        }
        .nav-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .nav-btn:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }
        .nav-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9em;
            box-sizing: border-box;
            cursor: pointer;
        }
        .input-group select option {
            background-color: white;
            color: #2c3e50;
            padding: 8px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }
        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }
        .mobile-menu-button {
            display: none;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 200;
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2em;
        }
        .mobile-menu-button:hover {
            background-color: #34495e;
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                overflow: auto;
            }
            .mobile-menu-button {
                display: block;
            }
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                max-width: 80vw;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                width: 100vw;
                min-height: 100vh;
                padding-top: 60px;
            }
            .navigation-buttons {
                top: 10px;
                right: 10px;
            }
            .nav-btn {
                padding: 6px 12px;
                font-size: 0.9em;
            }
            .input-group,
            .dimension-inputs,
            #generateBtn {
                max-width: 100%;
            }
            #generatedImage {
                max-height: calc(100vh - 60px);
            }
        }

        @media (max-width: 480px) {
            .navigation-buttons {
                padding: 5px;
                gap: 5px;
            }
            .nav-btn {
                padding: 4px 8px;
                font-size: 0.8em;
            }
            .cors-warning {
                font-size: 0.9em;
            }
            .cors-warning ol {
                padding-left: 15px;
            }
        }
        .token-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: #bdc3c7;
        }
        .token-category {
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        .token-category-name {
            color: #3498db;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .token-list {
            color: #95a5a6;
            font-style: italic;
            margin-top: 5px;
        }
        .token-actions {
            display: flex;
            gap: 5px;
        }
        .token-action-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            padding: 2px 5px;
            font-size: 0.9em;
        }
        .token-action-btn:hover {
            color: #2980b9;
        }
        .token-manager {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        .token-manager h3 {
            color: #3498db;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .token-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .token-form input,
        .token-form textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .token-form textarea {
            min-height: 60px;
            resize: vertical;
        }
        .token-form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .token-form-buttons button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
        }
        .token-form-buttons button:hover {
            background-color: #2980b9;
        }
        .token-form-buttons button.delete {
            background-color: #e74c3c;
        }
        .token-form-buttons button.delete:hover {
            background-color: #c0392b;
        }
        .config-manager {
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        .config-manager h3 {
            color: #3498db;
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .config-manager-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .config-manager-buttons button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
        }
        .config-manager-buttons button:hover {
            background-color: #2980b9;
        }
        .import-export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .import-export-buttons button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }
        .import-export-buttons button.export {
            background-color: #2ecc71;
        }
        .import-export-buttons button.export:hover {
            background-color: #27ae60;
        }
        .import-export-buttons button.import {
            background-color: #f39c12;
        }
        .import-export-buttons button.import:hover {
            background-color: #d35400;
        }
        .random-config-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            color: #ecf0f1;
        }
        .random-config-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .config-select-container {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .config-select {
            flex: 1;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 30px;
        }
        .config-select option {
            background-color: #2c3e50;
            color: white;
            padding: 8px;
        }
        .config-select:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .delete-config-btn {
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #e74c3c;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        .delete-config-btn:hover {
            background-color: #c0392b;
        }
        .delete-config-btn:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <button class="mobile-menu-button" onclick="toggleSidebar()">☰</button>
    <div class="sidebar">
        <div class="sidebar-content">
            <h2>Image Generator</h2>
            <div class="config-manager">
                <h3>Config Manager</h3>
                <div class="config-select-container">
                    <select id="configSelect" class="config-select">
                        <option value="">Select a config...</option>
                    </select>
                    <button id="deleteConfigBtn" class="delete-config-btn" onclick="deleteConfig()" disabled title="Delete Config">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
                <div class="config-manager-buttons">
                    <button onclick="saveConfig()">Save Config</button>
                    <button onclick="loadConfig()">Load Config</button>
                </div>
                <div class="import-export-buttons">
                    <button class="export" onclick="exportData()">Export Data</button>
                    <button class="import" onclick="importData()">Import Data</button>
                </div>
                <div class="random-config-checkbox">
                    <input type="checkbox" id="useRandomConfig" onchange="toggleRandomConfig()">
                    <label for="useRandomConfig">Use Random Config</label>
                </div>
            </div>
            <div id="corsWarning" class="cors-warning" style="display: none;">
                <strong>Note:</strong> To use this page, you need to:
                <ol>
                    <li>Install a CORS browser extension like <a href="https://chrome.google.com/webstore/detail/cors-unblock/lfhmikememgdcahcdlaciloancbhjino" target="_blank">CORS Unblock</a> for Chrome or <a href="https://addons.mozilla.org/en-US/firefox/addon/cors-everywhere/" target="_blank">CORS Everywhere</a> for Firefox</li>
                    <li>Enable the extension for localhost</li>
                    <li>Refresh this page</li>
                </ol>
            </div>
            <div class="config-group">
                <h3>ComfyUI Settings</h3>
                <div id="comfyStatus" class="error-message" style="display: none;">
                    ComfyUI API is not accessible. Using default models.
                </div>
                <div class="input-group">
                    <label for="comfyEndpoint">ComfyUI Endpoint</label>
                    <input type="text" id="comfyEndpoint" value="http://localhost:8188">
                </div>
                <div class="input-group">
                    <label for="comfyModelSelect">Model</label>
                    <select id="comfyModelSelect">
                        <option value="">Loading models...</option>
                    </select>
                </div>
                <div class="dimension-inputs">
                    <div class="input-group">
                        <label for="imageWidth">Width</label>
                        <input type="number" id="imageWidth" value="832" min="64" step="64">
                    </div>
                    <button class="switch-dimensions" onclick="switchDimensions()" title="Switch Width/Height">
                        <svg viewBox="0 0 24 24">
                            <path d="M16,17V5h1.5v12H16z M11.5,17V5H10v12H11.5z M15,5v12h-3V5H15z M8,5v12H5V5H8z M19,19H5v-1.5h14V19z M19,6.5H5V5h14V6.5z"/>
                        </svg>
                    </button>
                    <div class="input-group">
                        <label for="imageHeight">Height</label>
                        <input type="number" id="imageHeight" value="1216" min="64" step="64">
                    </div>
                </div>
            </div>
            <div class="config-group">
                <h3>Prompt Settings</h3>
                <div class="input-group">
                    <label for="basePrompt">Positive Prompt</label>
                    <textarea id="basePrompt">A [LANDSCAPE] landscape in [STYLE] style</textarea>
                </div>
                <div class="input-group">
                    <label for="negativePrompt">Negative Prompt</label>
                    <textarea id="negativePrompt">score_5, score_4,</textarea>
                </div>
                <div class="token-manager">
                    <h3>Token Manager</h3>
                    <div class="token-form">
                        <input type="text" id="tokenName" placeholder="Token Name (e.g., LANDSCAPE)">
                        <input type="text" id="tokenDisplayName" placeholder="Display Name (e.g., Landscape Type)">
                        <textarea id="tokenValues" placeholder="Enter values (one per line)"></textarea>
                        <div class="token-form-buttons">
                            <button onclick="addOrUpdateToken()">Add/Update Token</button>
                            <button class="delete" onclick="deleteToken()">Delete Token</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="config-group">
                <h3>Generation</h3>
                <button id="generateBtn" onclick="startGeneration()">Generate Image</button>
                <div class="checkbox-group">
                    <input type="checkbox" id="autoGenerate" onchange="toggleAutoGenerate()">
                    <label for="autoGenerate">Auto Generate</label>
                </div>
                <div id="status" class="status"></div>
            </div>
        </div>
    </div>
    <div class="main-content">
        <div class="container">
            <div id="result">
                <img id="generatedImage" alt="Generated image will appear here">
                <div class="navigation-buttons">
                    <button class="nav-btn" id="prevBtn" onclick="navigateHistory(-1)" disabled>Previous</button>
                    <button class="nav-btn" id="nextBtn" onclick="navigateHistory(1)" disabled>Next</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_COMFYUI_API = 'http://localhost:8188';
        let COMFYUI_API = localStorage.getItem('comfyEndpoint') || DEFAULT_COMFYUI_API;
        
        // Update endpoint when changed
        document.getElementById('comfyEndpoint').addEventListener('change', function() {
            COMFYUI_API = this.value;
            localStorage.setItem('comfyEndpoint', COMFYUI_API);
            fetchComfyModels();
        });

        // Set initial value
        document.getElementById('comfyEndpoint').value = COMFYUI_API;
        
        // Token definitions
        const tokens = {
            LANDSCAPE: {
                name: "Landscape",
                values: [
                    "mountain",
                    "hill",
                    "valley",
                    "cliff",
                    "canyon",
                    "ridge",
                    "plateau",
                    "glacier",
                    "peak",
                    "alpine"
                ]
            },
            STYLE: {
                name: "Landscape",
                values: [
                    "photorealistic",
                    "digital painting",
                    "watercolor",
                    "oil painting",
                    "low poly",
                    "pixel art",
                    "cinematic lighting",
                    "isometric",
                    "line art",
                    "studio ghibli style"
                ]
            },
        };

        // Default models in case API calls fail
        const defaultComfyModels = [
            'v1-5-pruned-emaonly.safetensors',
            'sd_xl_base_1.0.safetensors',
            'sd_xl_refiner_1.0.safetensors'
        ];

        let imageHistory = [];
        let currentIndex = -1;
        let isAutoGenerating = false;
        let isGenerating = false;
        let currentConfigName = "";

        // Token management
        const TOKENS_STORAGE_KEY = 'imageGeneratorTokens';
        
        function initializeTokens() {
            const storedTokens = localStorage.getItem(TOKENS_STORAGE_KEY);
            if (!storedTokens) {
                // Default tokens
                const defaultTokens = {
                    LANDSCAPE: {
                        name: "Landscape",
                        values: [
                            "mountain",
                            "hill",
                            "valley",
                            "cliff",
                            "canyon",
                            "ridge",
                            "plateau",
                            "glacier",
                            "peak",
                            "alpine"
                        ]
                    },
                    STYLE: {
                        name: "Style",
                        values: [
                            "photorealistic",
                            "digital painting",
                            "watercolor",
                            "oil painting",
                            "low poly",
                            "pixel art",
                            "cinematic lighting",
                            "isometric",
                            "line art",
                            "studio ghibli style"
                        ]
                    }
                };
                localStorage.setItem(TOKENS_STORAGE_KEY, JSON.stringify(defaultTokens));
                return defaultTokens;
            }
            return JSON.parse(storedTokens);
        }

        function saveTokens(tokens) {
            localStorage.setItem(TOKENS_STORAGE_KEY, JSON.stringify(tokens));
        }

        function addOrUpdateToken() {
            const nameInput = document.getElementById('tokenName');
            const displayNameInput = document.getElementById('tokenDisplayName');
            const valuesInput = document.getElementById('tokenValues');
            
            const tokenName = nameInput.value.trim().toUpperCase();
            const displayName = displayNameInput.value.trim();
            const values = valuesInput.value.split('\n').map(v => v.trim()).filter(v => v);
            
            if (!tokenName || !displayName || values.length === 0) {
                alert('Please fill in all fields and add at least one value');
                return;
            }
            
            const tokens = JSON.parse(localStorage.getItem(TOKENS_STORAGE_KEY) || '{}');
            tokens[tokenName] = {
                name: displayName,
                values: values
            };
            
            saveTokens(tokens);
            displayAvailableTokens();
            
            // Clear form
            nameInput.value = '';
            displayNameInput.value = '';
            valuesInput.value = '';
        }

        function deleteToken() {
            const tokenName = document.getElementById('tokenName').value.trim().toUpperCase();
            if (!tokenName) {
                alert('Please enter a token name to delete');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete the token [${tokenName}]?`)) {
                return;
            }
            
            const tokens = JSON.parse(localStorage.getItem(TOKENS_STORAGE_KEY) || '{}');
            delete tokens[tokenName];
            
            saveTokens(tokens);
            displayAvailableTokens();
            
            // Clear form
            document.getElementById('tokenName').value = '';
            document.getElementById('tokenDisplayName').value = '';
            document.getElementById('tokenValues').value = '';
        }

        function displayAvailableTokens() {
            const tokenInfo = document.createElement('div');
            tokenInfo.className = 'token-info';
            
            const title = document.createElement('div');
            title.textContent = 'Available Tokens:';
            title.style.marginBottom = '8px';
            tokenInfo.appendChild(title);

            const tokens = JSON.parse(localStorage.getItem(TOKENS_STORAGE_KEY) || '{}');
            
            for (const [key, category] of Object.entries(tokens)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'token-category';
                
                const categoryName = document.createElement('div');
                categoryName.className = 'token-category-name';
                
                const nameText = document.createElement('span');
                nameText.textContent = `[${key}] - ${category.name}`;
                categoryName.appendChild(nameText);
                
                const actions = document.createElement('div');
                actions.className = 'token-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'token-action-btn';
                editBtn.textContent = 'Edit';
                editBtn.onclick = () => editToken(key);
                actions.appendChild(editBtn);
                
                categoryName.appendChild(actions);
                categoryDiv.appendChild(categoryName);
                
                const tokenList = document.createElement('div');
                tokenList.className = 'token-list';
                tokenList.textContent = `e.g., ${category.values.slice(0, 3).join(', ')}...`;
                categoryDiv.appendChild(tokenList);
                
                tokenInfo.appendChild(categoryDiv);
            }

            // Remove existing token info if present
            const existingTokenInfo = document.querySelector('.token-info');
            if (existingTokenInfo) {
                existingTokenInfo.remove();
            }

            // Find the prompt input group and add the token info after it
            const promptGroup = document.querySelector('#basePrompt').closest('.input-group');
            promptGroup.appendChild(tokenInfo);
        }

        function editToken(tokenKey) {
            const tokens = JSON.parse(localStorage.getItem(TOKENS_STORAGE_KEY) || '{}');
            const token = tokens[tokenKey];
            
            if (token) {
                document.getElementById('tokenName').value = tokenKey;
                document.getElementById('tokenDisplayName').value = token.name;
                document.getElementById('tokenValues').value = token.values.join('\n');
            }
        }

        function getRandomValueForToken(tokenKey) {
            const tokens = JSON.parse(localStorage.getItem(TOKENS_STORAGE_KEY) || '{}');
            const category = tokens[tokenKey];
            if (!category) return '';
            return category.values[Math.floor(Math.random() * category.values.length)];
        }

        function replaceTokens(prompt) {
            // Replace all tokens in the format [TOKEN_NAME]
            return prompt.replace(/\[(\w+)\]/g, (match, tokenKey) => {
                const upperTokenKey = tokenKey.toUpperCase();
                return getRandomValueForToken(upperTokenKey) || match;
            });
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentIndex <= 0;
            nextBtn.disabled = currentIndex >= imageHistory.length - 1;
        }

        function navigateHistory(direction) {
            const newIndex = currentIndex + direction;
            if (newIndex >= 0 && newIndex < imageHistory.length) {
                currentIndex = newIndex;
                const historyItem = imageHistory[currentIndex];
                const imageElement = document.getElementById('generatedImage');
                imageElement.src = `${COMFYUI_API}/view?filename=${historyItem.filename}&subfolder=${historyItem.subfolder}&type=${historyItem.type}`;
                imageElement.style.display = 'block';
                document.getElementById('status').textContent = `Image ${currentIndex + 1}/${imageHistory.length} (${historyItem.prompt})`;
                updateNavigationButtons();
            }
        }

        function switchDimensions() {
            const widthInput = document.getElementById('imageWidth');
            const heightInput = document.getElementById('imageHeight');
            const tempWidth = widthInput.value;
            widthInput.value = heightInput.value;
            heightInput.value = tempWidth;
        }

        // Function to fetch ComfyUI models
        async function fetchComfyModels() {
            const modelSelect = document.getElementById('comfyModelSelect');
            const statusDiv = document.getElementById('comfyStatus');
            
            try {
                console.log('Attempting to fetch models from:', `${COMFYUI_API}/object_info`);
                
                const response = await fetch(`${COMFYUI_API}/object_info`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('API Response:', data);
                
                modelSelect.innerHTML = '';
                
                let models = defaultComfyModels;
                
                try {
                    // Try to extract models from the object info
                    if (data && data.CheckpointLoaderSimple && data.CheckpointLoaderSimple.input && data.CheckpointLoaderSimple.input.required) {
                        const ckptName = data.CheckpointLoaderSimple.input.required.ckpt_name;
                        console.log('ckptName:', ckptName);
                        
                        if (Array.isArray(ckptName[0])) {
                            // Handle both array formats: [["model1", "model2"]] and ["model1", "model2"]
                            models = Array.isArray(ckptName[0]) ? ckptName[0] : ckptName;
                            console.log('Parsed models:', models);
                        }
                    } else {
                        console.warn('Unexpected API response structure:', data);
                    }
                } catch (e) {
                    console.warn('Could not parse ComfyUI models:', e);
                }

                if (!Array.isArray(models) || models.length === 0) {
                    console.warn('No models found, using defaults');
                    models = defaultComfyModels;
                }

                // Add a default option first
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select a model...';
                modelSelect.appendChild(defaultOption);

                // Add all models
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });

                // Hide error message and CORS warning if successful
                statusDiv.style.display = 'none';
                document.getElementById('corsWarning').style.display = 'none';

                // After models are loaded, set the saved model if it exists
                if (window.selectedModel) {
                    modelSelect.value = window.selectedModel;
                    delete window.selectedModel;
                }
            } catch (error) {
                console.error('Error fetching ComfyUI models:', error);
                modelSelect.innerHTML = '';
                
                // Add a default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select a model...';
                modelSelect.appendChild(defaultOption);
                
                // Add default models
                defaultComfyModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });

                // Show error message and CORS warning
                statusDiv.textContent = `ComfyUI API Error: ${error.message}. Using default models.`;
                statusDiv.style.display = 'block';
                document.getElementById('corsWarning').style.display = 'block';
            }
        }

        // Add a function to test the API connection
        async function testApiConnection() {
            try {
                const response = await fetch(`${COMFYUI_API}/object_info`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                console.log('API Test Response:', {
                    status: response.status,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                return response.ok;
            } catch (error) {
                console.error('API Test Error:', error);
                return false;
            }
        }

        // Call testApiConnection when the page loads
        window.addEventListener('load', async () => {
            const isApiAvailable = await testApiConnection();
            console.log('API Available:', isApiAvailable);
            if (!isApiAvailable) {
                const statusDiv = document.getElementById('comfyStatus');
                statusDiv.textContent = 'ComfyUI API is not accessible. Please ensure ComfyUI is running at http://localhost:8188';
                statusDiv.style.display = 'block';
            }
        });

        function toggleAutoGenerate() {
            isAutoGenerating = document.getElementById('autoGenerate').checked;
            if (isAutoGenerating && !isGenerating) {
                startGeneration();
            }
        }

        async function generateImage(prompt) {
            try {
                const selectedModel = document.getElementById('comfyModelSelect').value;
                const width = parseInt(document.getElementById('imageWidth').value);
                const height = parseInt(document.getElementById('imageHeight').value);
                const negativePrompt = document.getElementById('negativePrompt').value;
                
                const workflow = {
                    "1": {
                        "inputs": {
                            "ckpt_name": selectedModel
                        },
                        "class_type": "CheckpointLoaderSimple"
                    },
                    "2": {
                        "inputs": {
                            "text": prompt,
                            "clip": ["1", 1]
                        },
                        "class_type": "CLIPTextEncode"
                    },
                    "3": {
                        "inputs": {
                            "text": negativePrompt,
                            "clip": ["1", 1]
                        },
                        "class_type": "CLIPTextEncode"
                    },
                    "4": {
                        "inputs": {
                            "width": width,
                            "height": height,
                            "batch_size": 1
                        },
                        "class_type": "EmptyLatentImage"
                    },
                    "5": {
                        "inputs": {
                            "seed": Math.floor(Math.random() * 1000000),
                            "steps": 20,
                            "cfg": 7,
                            "sampler_name": "euler",
                            "scheduler": "normal",
                            "denoise": 1,
                            "model": ["1", 0],
                            "positive": ["2", 0],
                            "negative": ["3", 0],
                            "latent_image": ["4", 0]
                        },
                        "class_type": "KSampler"
                    },
                    "6": {
                        "inputs": {
                            "samples": ["5", 0],
                            "vae": ["1", 2]
                        },
                        "class_type": "VAEDecode"
                    },
                    "7": {
                        "inputs": {
                            "images": ["6", 0],
                            "filename_prefix": "ComfyUI"
                        },
                        "class_type": "SaveImage"
                    }
                };

                const response = await fetch(`${COMFYUI_API}/prompt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: workflow })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}\n${JSON.stringify(errorData, null, 2)}`);
                }

                const data = await response.json();
                const promptId = data.prompt_id;

                // Poll for the result
                while (true) {
                    const historyResponse = await fetch(`${COMFYUI_API}/history/${promptId}`);
                    const historyData = await historyResponse.json();
                    
                    if (historyData[promptId]) {
                        const outputs = historyData[promptId].outputs;
                        if (outputs && outputs["7"] && outputs["7"].images) {
                            return {
                                filename: outputs["7"].images[0].filename,
                                subfolder: outputs["7"].images[0].subfolder,
                                type: outputs["7"].images[0].type
                            };
                        }
                    }
                    
                    // Wait before polling again
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            } catch (error) {
                console.error('Error generating image:', error);
                throw error;
            }
        }

        async function startGeneration() {
            if (isGenerating) return;

            const generateBtn = document.getElementById('generateBtn');
            const statusDiv = document.getElementById('status');
            const imageElement = document.getElementById('generatedImage');

            try {
                isGenerating = true;
                generateBtn.disabled = true;
                statusDiv.innerHTML = '<span class="loading"></span>Generating image...';
                
                // Check if we should use a random config
                if (document.getElementById('useRandomConfig').checked) {
                    randomizeConfig();
                }
                
                const basePrompt = document.getElementById('basePrompt').value;
                const negativePrompt = document.getElementById('negativePrompt').value;
                const finalPrompt = replaceTokens(basePrompt);
                
                const result = await generateImage(finalPrompt);
                
                // Add to history
                imageHistory.push({
                    ...result,
                    prompt: finalPrompt
                });
                currentIndex = imageHistory.length - 1;
                
                imageElement.src = `${COMFYUI_API}/view?filename=${result.filename}&subfolder=${result.subfolder}&type=${result.type}`;
                imageElement.style.display = 'block';
                
                statusDiv.textContent = `Image ${currentIndex + 1}/${imageHistory.length} (${finalPrompt})`;
                updateNavigationButtons();

                // If auto-generate is enabled, wait for the image to load and start next generation
                if (isAutoGenerating) {
                    imageElement.onload = () => {
                        setTimeout(() => {
                            if (isAutoGenerating) {
                                startGeneration();
                            }
                        }, 1000);
                    };
                }
            } catch (error) {
                statusDiv.textContent = 'Error: ' + error.message;
                if (isAutoGenerating) {
                    setTimeout(() => {
                        if (isAutoGenerating) {
                            startGeneration();
                        }
                    }, 5000);
                }
            } finally {
                isGenerating = false;
                generateBtn.disabled = isAutoGenerating;
            }
        }

        // Config management
        const CONFIG_STORAGE_KEY = 'imageGeneratorConfigs';
        const DEFAULT_CONFIG = {
            width: 832,
            height: 1216,
            positivePrompt: "A [LANDSCAPE] landscape in [STYLE] style",
            negativePrompt: "score_5, score_4,",
            selectedModel: ""
        };

        function initializeConfigs() {
            const storedConfigs = localStorage.getItem(CONFIG_STORAGE_KEY);
            if (!storedConfigs) {
                const defaultConfigs = {
                    "Default": DEFAULT_CONFIG
                };
                localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(defaultConfigs));
                return defaultConfigs;
            }
            return JSON.parse(storedConfigs);
        }

        function saveConfigs(configs) {
            localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(configs));
            updateConfigSelect();
        }

        function updateConfigSelect() {
            const configSelect = document.getElementById('configSelect');
            const deleteBtn = document.getElementById('deleteConfigBtn');
            const configs = JSON.parse(localStorage.getItem(CONFIG_STORAGE_KEY) || '{}');
            
            configSelect.innerHTML = '<option value="">Select a config...</option>';
            Object.keys(configs).forEach(configName => {
                const option = document.createElement('option');
                option.value = configName;
                option.textContent = configName;
                configSelect.appendChild(option);
            });

            // Restore the current config selection
            if (currentConfigName) {
                configSelect.value = currentConfigName;
            }

            // Enable/disable delete button based on selection
            deleteBtn.disabled = !currentConfigName || currentConfigName === "Default";
        }

        function loadConfig(configName) {
            if (!configName) return;

            const configs = JSON.parse(localStorage.getItem(CONFIG_STORAGE_KEY) || '{}');
            const config = configs[configName];

            if (config) {
                currentConfigName = configName;
                document.getElementById('imageWidth').value = config.width;
                document.getElementById('imageHeight').value = config.height;
                document.getElementById('basePrompt').value = config.positivePrompt;
                document.getElementById('negativePrompt').value = config.negativePrompt;
                
                // Set the model if it exists in the current options
                const modelSelect = document.getElementById('comfyModelSelect');
                if (config.selectedModel && Array.from(modelSelect.options).some(opt => opt.value === config.selectedModel)) {
                    modelSelect.value = config.selectedModel;
                }
            }
        }

        function saveConfig() {
            const configSelect = document.getElementById('configSelect');
            let configName = configSelect.value;
            
            // If no config is selected (not even Default), ask for a name
            if (!configName) {
                configName = prompt('Enter a name for this config:');
                if (!configName) return;
            }

            const config = {
                width: parseInt(document.getElementById('imageWidth').value),
                height: parseInt(document.getElementById('imageHeight').value),
                positivePrompt: document.getElementById('basePrompt').value,
                negativePrompt: document.getElementById('negativePrompt').value,
                selectedModel: document.getElementById('comfyModelSelect').value
            };

            const configs = JSON.parse(localStorage.getItem(CONFIG_STORAGE_KEY) || '{}');
            configs[configName] = config;
            saveConfigs(configs);
            
            // Update current config name and select
            currentConfigName = configName;
            updateConfigSelect();
        }

        function randomizeConfig() {
            const configs = JSON.parse(localStorage.getItem(CONFIG_STORAGE_KEY) || '{}');
            const configNames = Object.keys(configs);
            if (configNames.length === 0) return;

            const randomConfigName = configNames[Math.floor(Math.random() * configNames.length)];
            const configSelect = document.getElementById('configSelect');
            configSelect.value = randomConfigName;
            loadConfig(randomConfigName);
        }

        function toggleRandomConfig() {
            const useRandom = document.getElementById('useRandomConfig').checked;
            const configSelect = document.getElementById('configSelect');
            configSelect.disabled = useRandom;
        }

        function deleteConfig() {
            const configSelect = document.getElementById('configSelect');
            const selectedConfig = configSelect.value;
            
            if (!selectedConfig || selectedConfig === "Default") return;
            
            if (!confirm(`Are you sure you want to delete the config "${selectedConfig}"?`)) {
                return;
            }

            const configs = JSON.parse(localStorage.getItem(CONFIG_STORAGE_KEY) || '{}');
            delete configs[selectedConfig];
            saveConfigs(configs);
            
            // Clear selection
            configSelect.value = "";
            updateConfigSelect();
        }

        // Add event listener for config select changes
        document.getElementById('configSelect').addEventListener('change', function() {
            const selectedConfig = this.value;
            loadConfig(selectedConfig);
        });

        // Initialize configs when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeConfigs();
            initializeTokens();
            fetchComfyModels();
            displayAvailableTokens();
            updateConfigSelect();
            
            // Load the default config if it exists
            const configs = JSON.parse(localStorage.getItem(CONFIG_STORAGE_KEY) || '{}');
            if (Object.keys(configs).length > 0) {
                currentConfigName = "Default";
                loadConfig("Default");
            }
        });

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('active');
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('.sidebar');
            const mobileMenuButton = document.querySelector('.mobile-menu-button');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(e.target) && 
                !mobileMenuButton.contains(e.target) &&
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            const sidebar = document.querySelector('.sidebar');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('active');
            }
        });

        function exportData() {
            try {
                // Get all localStorage data
                const data = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    data[key] = localStorage.getItem(key);
                }
                
                // Convert to JSON and base64 encode
                const jsonData = JSON.stringify(data);
                const base64Data = btoa(jsonData);
                
                // Create download link
                const blob = new Blob([base64Data], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'image_generator_backup.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('Data exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting data: ' + error.message);
            }
        }

        function importData() {
            try {
                // Create file input
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.txt';
                
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            // Read and decode the data
                            const base64Data = e.target.result;
                            const jsonData = atob(base64Data);
                            const data = JSON.parse(jsonData);
                            
                            // Clear existing data
                            localStorage.clear();
                            
                            // Import new data
                            for (const [key, value] of Object.entries(data)) {
                                localStorage.setItem(key, value);
                            }
                            
                            // Refresh the UI
                            updateConfigSelect();
                            displayAvailableTokens();
                            
                            // Load the default config if it exists
                            const configs = JSON.parse(localStorage.getItem(CONFIG_STORAGE_KEY) || '{}');
                            if (Object.keys(configs).length > 0) {
                                currentConfigName = "Default";
                                loadConfig("Default");
                            }
                            
                            alert('Data imported successfully!');
                        } catch (error) {
                            console.error('Import error:', error);
                            alert('Error importing data: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                };
                
                input.click();
            } catch (error) {
                console.error('Import error:', error);
                alert('Error importing data: ' + error.message);
            }
        }
    </script>
</body>
</html> 